<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>一带一路金融科技网系统-编辑文章</title>
    <bootstrapcss />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/statics/ueditor1.4.3.3/third-party/video-js/video-js.min.css"/>
    <style type="text/css">
    .upfileClickBootstrapt{opacity: 0; display: inline-block;height: 100%;width: 100%;margin-top: -20px;margin-left: -12px;}
	.upfileBootstrapt{width:54px;height: 34px;text-align: center;vertical-align: middle;}
	.bjy-admin-nav{color:#337ab7;}
	#form1{padding:8px;clear:both;float:left;}
	p{padding:10px 10px 0 10px;height:30px;line-height:30px;}
	p span{background-color:#eee;display:inline-block;height:28px;line-height:28px;padding:0 8px;margin-right:10px;}
	p span#lines{background-color:#fff;float:right;}
	select.caiwu,input.txt{height:35px;line-height:35px;border:1px solid #ccc;}
	p.tag{margin:0 0 15px;}
	p.tag .btn{margin:0 10px 0 0;}
	p.multiple_p{height:50px;}
	#select_th{display:none;}
	select.select_mj{width:100px;padding-left:8px;}
	select.caiwu,select option{padding-left:8px;}
	input.txt{width:187px;padding:0 8px;}
	input.txt_w{width:270px;}
	input.txt_w2{width:120px;font-weight:bold;}
	input[type="checkbox"]{background-color:#fff;}
	.export{float:right;}
	.btn-group{float:right; padding-bottom:10px;display:none;}
	.btn-group .multiselect{width:138px;}
	.btnwidth{width:96px;}
	.dropdown-menu{padding-left:8px;min-width: 137px;top: 78%;}
	li.active{background-color:none;}
	tr,th{text-align:center;}
	#table1 tr td{display:table-cell; vertical-align:middle;}
	#table1 tr td span{display:block;}
	.popover-content{color:#666;}
	.page{margin:0px 0 20px 0;padding:0 0 10px 0;float:right;}
	.page div{display:inline-block;}
	.page a,.page span {
		display:inline-block;
		padding:0px 10px;
		height:28px;
		line-height:28px;
		margin:0 1px;
		border:1px solid #f0f0f0;
		-webkit-border-radius:3px;
		-moz-border-radius:3px;
		border-radius:3px;
	}
	.page a,.page li {
		display:inline-block;
		list-style: none;
		text-decoration:none; 
		color:#58A0D3;
	}
	.page a.first,.page a.prev,.page a.next,.page a.end{
		margin:0;
	}
	.page a:hover{
		border-color:#50A8E6;
	}
	.page span.current{
		background:#50A8E6;
		color:#FFF;
		font-weight:700;
		border-color:#50A8E6;
	}
	span.pagesize, span.pagenum{
		border:none;
		color:#666;
	}
	#table1 tr td.last a{color:#169dd5;margin-right:10px;}
	.pagesize select{height:26px;line-height:26px;}
	.pagenum input{width:50px;height:28px;line-height:28px;text-align:center;border:1px solid #666}
	.img-list img{
		max-height:100px;
		margin:5px;
	}
	.operate-memo.active{
		border-color:red;
	}
	.btn-right{float:right;}
	</style>
</head>
<body>
<div class="bjy-admin-nav">
    <i class="fa fa-home"></i> 首页
    &gt;
    板块管理
    &gt;
    编辑文章
</div>
<div class="container">
    <form action="{:U('Module/editContent')}" method="post" enctype="multipart/form-data" onsubmit="return subArticle()">
        <div class="panel panel-default">
            <div class="panel-heading">添加文章</div>
            <div class="panel-body">
                <div class="form-inline"  style="margin-bottom:20px;">
                    <div class="form-group">
                        <label class="control-label">文章名称</label>
                        <input type="text" class="form-control" name="articleName" value="{$data['title']}" style="width:200px;" >
                    </div>
                    <div class="form-group">
                        <label class="control-label">选择主板块</label>
                        <select class="form-control" style="width:200px" value="{$data['nav1_id']}" name='moduleOne' onchange="changeModule('class_one', this)">
                            <option value="0">请选择</option>
                            <foreach name='module' item='mod'>
                                <option value="{$mod['id']}" <if condition="$data['nav1_id'] eq $mod['id']">selected</if>>{$mod['name']}</option>
                            </foreach>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="control-label" >选择分板块</label>
                        <select class="form-control" style="width:200px" name="moduleTwo">
                            <option value="0">选择分版块</option>
                        </select>
                    </div>
                </div>
                <div class="form-inline"  style="margin-bottom:20px;">
                    <div class="form-group">
                        <label class="control-label">文章描述</label>
                        <input type="text" class="form-control" name="description" value="{$data['description']}" style="width:200px;" >
                    </div>
                    <div class="form-group">
                        <label class="control-label">文章作者</label>
                        <input type="text" class="form-control" name="author" value="{$data['author']}" style="width:200px;" >
                    </div>
                    <div class="form-group">
                        <label class="control-label">编辑人员</label>
                        <input type="text" class="form-control" name="editor" value="{$data['editor']}" style="width:200px;" >
                    </div>
                </div>
                <div class="form-inline" style="margin-bottom:20px;">
                    <div class="form-group">
                        <label class="control-label">文章来源</label>
                        <input type="text" class="form-control" name="source" value="{$data['source']}" style="width:200px;" >
                    </div>
                    <div class="form-group">
                        <label class="control-label">发布时间</label>
                        <input type="text" class="form-control" name="time" value="{$data['time'] ? date('Y-m-d H:i:s', $data['time']) : ''}" placeholder="年-月-日 时：分：秒" onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})" AUTOCOMPLETE="off" style="width:200px;" >
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="radio" name='coverType' value="1" <if condition="$data['cover_type'] eq 1">checked</if> onclick="selectCover(this)">封面图片
                        </label>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="radio" name='coverType' value="2" <if condition="$data['cover_type'] eq 2">checked</if> onclick="selectCover(this)">封面视频
                        </label>
                    </div>
                </div>
                <div class="form-horizontal"  style="margin-bottom:20px;display:none" id="coverImage">
                    <div class="form-group">
                        <div class="row">
                            <label class="control-label col-xs-1" style="width:80px;">封面图片</label>
                            <div class="col-xs-2" style="width:190px;">
                                <div class="thumbnail">
                                    <if condition="$data['cover_type'] eq 1 && $data['cover']">
                                        <img src="{$data['cover']}" alt="添加图片" style="width:100px;height: 100px;">
                                        <input type='hidden' name='coverImageOld' value="{$data['cover']}">
                                        <div class="caption">
                                            <p>
                                                <a href="javascript:;" class="btn btn-danger" role="button" onclick="delFile(this ,'image')">删除</a> 
                                                <a href="javascript:;" class="btn btn-info upfileBootstrapt" role="button" >上传<input type='file' name="coverImage" accept="image/*" onchange="changeIcon(this, 'image')" class="upfileClickBootstrapt"></a>
                                            </p>
                                        </div>
                                    <else />
                                        <img src="__PUBLIC__/statics/images/default_icon.jpg" alt="添加图片" style="width:100px;height: 100px;">
                                        <input type='hidden' name='coverImageOld' value="">
                                        <div class="caption">
                                            <p>
                                                <a href="javascript:;" class="btn btn-danger" role="button" onclick="delFile(this ,'image')">删除</a> 
                                                <a href="javascript:;" class="btn btn-info upfileBootstrapt" role="button" >上传<input type='file' name="coverImage" accept="image/*" onchange="changeIcon(this, 'image')" class="upfileClickBootstrapt"></a>
                                            </p>
                                        </div>
                                    </if>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-horizontal"  style="margin-bottom:20px;display:none" id="coverVideo">
                    <div class="form-group">
                        <div class="row">
                            <label class="control-label col-xs-1" style="width:80px;">封面视频</label>
                            <div class="col-xs-2" style="width:190px;">
                                <div class="thumbnail">
                                    <if condition="$data['cover_type'] eq 2 && $data['cover']">
                                        <video src="{$data['cover']}" controls="controls" preload="meta" style="width:100px;height: 100px;" poster="">
                                            您的浏览器不支持 video 标签。
                                        </video>
                                        <input type='hidden' name='coverVideoOld' value="{$data['cover']}">
                                        <div class="caption">
                                            <p>
                                                <a href="javascript:;" class="btn btn-danger" role="button" onclick="delFile(this, 'video')">删除</a> 
                                                <a href="javascript:;" class="btn btn-info upfileBootstrapt" role="button" >上传<input type='file' name="coverVideo"  accept="video/*" onchange="changeIcon(this, 'video')"  class="upfileClickBootstrapt"></a>
                                            </p>
                                        </div>
                                    <else />
                                        <video src="" controls="controls" preload="meta" style="width:100px;height: 100px;" poster="__PUBLIC__/statics/images/2016110214.jpg">
                                            您的浏览器不支持 video 标签。
                                        </video>
                                        <input type='hidden' name='coverVideoOld' value="">
                                        <div class="caption">
                                            <p>
                                                <a href="javascript:;" class="btn btn-danger" role="button" onclick="delFile(this, 'video')">删除</a> 
                                                <a href="javascript:;" class="btn btn-info upfileBootstrapt" role="button" >上传<input type='file' name="coverVideo"  accept="video/*" onchange="changeIcon(this, 'video')"  class="upfileClickBootstrapt"></a>
                                            </p>
                                        </div>
                                    </if>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class='page-header'>
                    <h3>详情介绍</h3>
                </div>
                <script id="ue_detail" name="detail" type="text/plain">
                    
                </script>
                <input type="hidden" name='detail' value="{$data['']}">
                <input type="hidden" name='id' value="{$data['id']}">
                <div class="form-horizontal">
                    <div class="form-group">
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-5 col-sm-7">
                            <input class="btn btn-success" type="submit" value="保存">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<bootstrapjs />
<script type="text/javascript" src="__PUBLIC__/statics/js/sha1.js"></script>
<script  src="__PUBLIC__/statics/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/layer/layer.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/js/common-ajax.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/js/common.js"></script>
<script src="__PUBLIC__/statics/js/base64.js"></script>
<script src="__PUBLIC__/statics/js/ajaxfileupload.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/ueditor1.4.3.3/ueditor.config.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/ueditor1.4.3.3/ueditor.all.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/ueditor1.4.3.3/third-party/video-js/video.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/ueditor1.4.3.3/ueditor.parse.js"></script>
<script type="text/javascript" src="__PUBLIC__/statics/ueditor1.4.3.3/lang/zh-cn/zh-cn.js"></script> 
<script type="text/javascript">
    var ue_detail = UE.getEditor('ue_detail',{
        autoHeight: true
    });
    //对编辑器的操作最好在编辑器ready之后再做
	ue_detail.ready(function() {
        //设置编辑器的内容
        var detail = '{$data["content"]}';
        ue_detail.setContent(detail);
        ue_detail.setHeight(400);
	    //获取html内容，返回: <p>hello</p>
	    //var html = ue_detail.getContent();
	    //获取纯文本内容，返回: hello
	    //var txt = ue_detail.getContentTxt();
	});
    UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
	UE.Editor.prototype.getActionUrl = function(action) {
	    if (action == 'uploadimage' || action == 'uploadscrawl') {
	        return "/Admin/Module/upLoad";
	    } else if (action == 'uploadvideo') {
	        return "/Admin/Module/upLoad";
	    } else {
	        return this._bkGetActionUrl.call(this, action);
	    }
    }
    

function subArticle ()
{
    var articleName = $("[name='articleName']").val().trim();
    var moduleOne = $("[name='moduleOne']").val();
    var moduleTwo = $("[name='moduleTwo']").val();
    var description = $("[name='description']").val().trim();
    var source = $("[name='source']").val().trim();
    var author = $("[name='author']").val().trim();
    var editor = $("[name='editor']").val().trim();
    var time = $("[name='time']").val().trim();
    var detail = ue_detail.getContent();
    if (!articleName) {
        alert('请填写文章名称');return false;
    }
    if (moduleOne == '0') {
        alert('请选择主版块');return false;
    }
    // if (moduleTwo == '0') {
    //     alert('请选择分版块');return false;
    // }
    // if (!description) {
    //     alert('请填写文章描述');return false;
    // }
    if (!source) {
        alert('请填写文章来源');return false;
    }
    if (!author) {
        alert('请填写文章作者');return false;
    }
    if (!editor) {
        alert('请填写编辑人员');return false;
    }
    if (!time) {
        alert('请填写发布时间');return false;
    }
    if (!detail) {
        alert('请填写文章内容');return false;
    }
    return true;
}

function selectCover (obj)
{
    var val = $(obj).val();
    if (val == 1) {
        $('#coverImage').show();
        $('#coverVideo').hide();
    } else if (val == 2){
        $('#coverImage').hide();
        $('#coverVideo').show();
    }
}

function changeIcon (obj, type) {
    var imgType = {png:'true',jpeg:'true',jpg:'true'};  
    var reader = new FileReader();
    var fileInfo = $(obj).get(0).files[0];
    var typeAll = fileInfo['type'];
    var size = fileInfo['size'];
    var name = fileInfo['name'];
    var fileType = typeAll.substring(0,typeAll.indexOf('/'));
    var ext = typeAll.substring(typeAll.indexOf('/')+1);
    if (type == 'image') {
        if (fileType != 'image') {
            layer.msg('只能上传图片类型的文件');
            return false;
        }
        if(!imgType[ext]){
            layer.msg('请上传png,jpeg,jpg的图片类型');
            return false;
        }
        if(size > 1024*1024*5){
            layer.msg('请上传5M以内的图片');
            return false;
        }
    } else if (type == 'video') {
        if (fileType != 'video') {
            layer.msg('只能上传视频类型的文件');
            return false;
        }
        if(size > 1024*1024*10){
            layer.msg('请上传10M以内的视频');
            return;
        }
    } else {
        layer.msg('该文件类型不能上传！');
        return false;
    }
    reader.onload = function(e) {
        if (type == 'image') {
            $(obj).closest('.thumbnail').find('img').attr('src', this.result);
        } else if (type == 'video') {
            $(obj).closest('.thumbnail').find('video').attr('src', this.result);
            $(obj).closest('.thumbnail').find('video').attr('poster', '');
        } else {
            return;
        }
        $(obj).closest('.thumbnail').find(':hidden').attr('value', '');
        
    }
    reader.readAsDataURL(fileInfo);
}

function delFile (obj, type) {
    if (type == 'image') {
        $(obj).closest('.thumbnail').find('img').attr('src', '__PUBLIC__/statics/images/default_icon.jpg');
        $(obj).closest('.thumbnail').find(':file').attr('value', '');
    $(obj).closest('.thumbnail').find(':hidden').attr('value', '');
    } else if (type == 'video') {
        $(obj).closest('.thumbnail').find('video').attr('src', '');
        $(obj).closest('.thumbnail').find('video').attr('poster', '__PUBLIC__/statics/images/2016110214.jpg');        
    } else {
        return;
    }
    $(obj).closest('.thumbnail').find(':file').attr('value', '');
    $(obj).closest('.thumbnail').find(':hidden').attr('value', '');
}

function changeModule (type, obj) {
    if (type == 'search') {
        var one = 'module_id_one';
        var two = 'module_id_two';
    } else {
        var one = 'moduleOne';
        var two = 'moduleTwo';
    }
    var module_id_one = $(obj).val();
    if (module_id_one == '0') {
        $("select[name="+two+"]").val('0');
        $("select[name="+two+"]").html('<option value="">请选择分类</option>');
        return;
    }
    var index = layer.load(10, {
        shade: [0.6,'#fff'] //0.1透明度的白色背景
    });
    AjaxRequest("{:U('Module/getModule')}",{module_id_one:module_id_one},function(res){
        layer.close(index);
        if (res.code != 200) {
            layer.msg('数据错误，请重新选择分类');
            $("select[name="+one+"]").val('0');
            $("select[name="+two+"]").val('0');
            $("select[name="+two+"]").html('<option value="0">请选择分类</option>');
            return;
        }
        var data = res.data;
        var html = '';
        html = html + '<option value="0">请选择分版块</option>';
        for (var i in data) {
            //if (data[i]['data_type'] == '0')
                html = html + '<option value="'+data[i]['id']+'" >'+data[i]['name']+'</option>';
        }
        $("select[name="+two+"]").html(html);
        $("select[name="+two+"]").val('0');
    });
}

function showModule (type, module_id_one, module_id_two) {
    if (type == 'search') {
        var one = 'module_id_one';
        var two = 'module_id_two';
    } else {
        var one = 'moduleOne';
        var two = 'moduleTwo';
    } 
    if (module_id_one != '0') {
		AjaxRequest("{:U('Module/getModule')}",{module_id_one:module_id_one},function(res){
			if (res.code != 200) {
				layer.msg('数据错误，请重新选择分类');
				$("select[name="+one+"]").val('0');
                $("select[name="+two+"]").val('0');
                $("select[name="+two+"]").html('<option value="0">请选择分类</option>');
				return;
			}
			var data = res.data;
			var html = '';
			html = html + '<option value="0">请选择分类</option>';
			for (var i in data) {
                //if (data[i]['data_type'] == '0') {
                    html = html + '<option value="'+data[i]['id']+'" >'+data[i]['name']+'</option>';                   
                //}
            }
			module_id_two ? '' : module_id_two = '0';
			$("select[name='moduleTwo']").html(html);
			$("select[name='moduleTwo']").val(module_id_two);
		});
	}
}


$(function(){
    var module_id_one = "{$data['nav1_id']}" ? "{$data['nav1_id']}" : '0';
    var module_id_two = "{$data['nav2_id']}" ? "{$data['nav2_id']}" : '0';
    showModule('search', module_id_one, module_id_two);



    var coverType = $("[name='coverType']:checked").val();
    if (coverType == 1) {
        $('#coverImage').show();
        $('#coverVideo').hide();
    } else if (coverType == 2){
        $('#coverImage').hide();
        $('#coverVideo').show();
    }
})
</script>
</body>
</html>